# 架构设计文档

## 存储结构设计

### MD5 分片策略

为了避免单个文件夹下文件数量过多，本项目采用 MD5 哈希分片存储策略：

1. **对 key 进行 MD5 加密**
   - 例如：`username` → `14c4b06b824ec593239362517f538b29`

2. **创建3层嵌套文件夹**
   - 第1位字符作为第1层文件夹：`1`
   - 第2位字符作为第2层文件夹：`4`
   - 第3位字符作为第3层文件夹：`c`
   - 第4位字符作为文件名：`4.json`
   - 完整路径：`cache/1/4/c/4.json`

3. **使用 MD5 作为存储 key**
   - 在 JSON 文件中，使用完整的 MD5 值作为 key
   - 存储原始 key、value 和时间戳

### 文件结构示例

```
cache/
├── 1/
│   └── 4/
│       └── c/
│           └── 4.json
├── 0/
│   └── c/
│       └── 8/
│           └── 3.json
└── 7/
    └── d/
        └── 6/
            └── 3.json
```

### JSON 文件内容格式

```json
{
  "14c4b06b824ec593239362517f538b29": {
    "key": "username",
    "value": "zhangsan",
    "timestamp": 1765813150441
  }
}
```

## 设计优势

### 1. 避免大文件读写
- 每个文件只存储少量相关的缓存项
- 读写操作只影响单个小文件，性能更好

### 2. 文件系统友好
- 3层嵌套结构避免单个文件夹下文件过多
- 理论上可以支持 16^4 = 65,536 个不同的文件
- 每层最多16个子文件夹（0-9, a-f）

### 3. 哈希冲突处理
- 相同 MD5 前4位的 key 会存储在同一个文件中
- 使用完整 MD5 作为文件内的 key，避免冲突
- 同一文件内的多个 key 可以批量读写

### 4. 可扩展性
- 如果需要更细的分片，可以增加嵌套层级
- 如果需要更粗的分片，可以减少嵌套层级
- 当前设计在性能和复杂度之间取得平衡

## 性能特点

- **写入**：O(1) - 直接定位到文件并更新
- **读取**：O(1) - 直接定位到文件并读取
- **删除**：O(1) - 直接定位到文件并删除
- **遍历**：O(n) - 需要遍历所有文件

## 适用场景

### 适合使用
- 单进程、单线程应用
- 中小规模缓存（< 100万条记录）
- 命令行工具、脚本程序
- 开发环境数据 Mock
- 本地配置存储
- 不需要复杂查询的 key-value 存储

### 不适合使用
- 多进程/多线程并发访问
- Node.js cluster 集群模式
- 分布式系统
- 高并发 Web 服务
- 需要事务支持的场景

## 并发安全性

### 限制说明

本库是一个**简易的单进程缓存系统**，设计上不考虑并发安全：

1. **无文件锁机制**
   - 多个进程同时写入可能导致数据损坏
   - 没有实现文件锁或进程间同步

2. **同步 I/O 操作**
   - 所有文件操作都是同步的
   - 在单线程环境中按顺序执行
   - 不适合异步并发场景

3. **无事务支持**
   - 没有原子性保证
   - 操作失败可能导致数据不一致

### 替代方案

如果需要并发支持，建议使用：
- **Redis**：内存缓存，支持高并发
- **SQLite**：文件数据库，支持事务和锁
- **LevelDB**：嵌入式 key-value 数据库
- **node-cache**：内存缓存（不持久化）
